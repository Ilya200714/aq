<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MEGA P2P PRO V5</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #5865F2; --bg: #313338; --card: #2B2D31; --green: #23a559; --red: #da373c; --gold: #f1c40f; }
        body { margin: 0; font-family: 'Whitney', 'Helvetica Neue', sans-serif; background: #1e1f22; color: white; overflow: hidden; }
        
        /* –°–µ—Ç–∫–∞ –≤–∏–¥–µ–æ */
        #main-app { display: none; height: 100vh; flex-direction: row; }
        .video-side { flex: 1; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 25px; background: var(--bg); padding: 20px; overflow-y: auto; }
        
        /* –í–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã */
        .user-node { display: flex; flex-direction: column; align-items: center; gap: 12px; perspective: 1000px; }
        .v-wrap { width: 190px; height: 190px; border-radius: 50%; border: 4px solid #4e5058; overflow: hidden; position: relative; background: #000; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .v-wrap.me { border-color: var(--gold); box-shadow: 0 0 20px rgba(241, 196, 15, 0.3); }
        .v-wrap.speaking { border-color: var(--green); box-shadow: 0 0 20px var(--green); transform: scale(1.05); }
        video { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; position: absolute; z-index: 2; background: black; }
        .ava-img { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 1; border-radius: 50%; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .screen { height: 100vh; display: flex; justify-content: center; align-items: center; flex-direction: column; background: radial-gradient(circle, #313338 0%, #1e1f22 100%); }
        .card { background: var(--card); padding: 40px; border-radius: 20px; width: 350px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); }
        input, select { width: 100%; padding: 14px; margin: 10px 0; border-radius: 8px; border: none; background: #1e1f22; color: white; font-size: 16px; outline: none; border: 1px solid transparent; transition: 0.2s; }
        input:focus { border-color: var(--accent); }
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; background: var(--accent); color: white; font-weight: bold; font-size: 16px; margin-top: 10px; transition: 0.3s; }
        button:hover { filter: brightness(1.2); transform: translateY(-2px); }

        /* –ß–∞—Ç */
        .chat-side { width: 340px; background: var(--card); border-left: 2px solid #1e1f22; display: flex; flex-direction: column; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 20px; font-size: 14px; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: #383a40; padding: 10px; border-radius: 10px; position: relative; max-width: 90%; }
        .msg b { color: var(--accent); display: block; margin-bottom: 4px; }
        .emoji-row { display: flex; justify-content: space-around; padding: 10px; background: #2b2d31; border-top: 1px solid #1e1f22; font-size: 22px; }
        .emoji-row span { cursor: pointer; transition: 0.2s; }
        .emoji-row span:hover { transform: scale(1.3); }

        /* –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ */
        .controls { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; background: rgba(0,0,0,0.85); padding: 15px 25px; border-radius: 50px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
        .btn { width: 55px; height: 55px; border-radius: 50%; border: none; background: #4e5058; color: white; cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .btn:hover { background: #6d6f78; }
        .btn.off { background: var(--red); }
        
        #settings-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="settings-modal">
        <div class="card">
            <h2 style="margin-top:0">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <input type="text" id="set-nick-input" placeholder="–í–∞—à –Ω–∏–∫">
            <button onclick="document.getElementById('set-file').click()" style="background:#4e5058">–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä (–ü–ö)</button>
            <input type="file" id="set-file" hidden accept="image/*" onchange="uploadAva(this, true)">
            
            <div style="text-align:left; font-size:12px; margin-top:10px; color:#aaa;">
                <label>–ú–∏–∫—Ä–æ—Ñ–æ–Ω</label><select id="sel-mic"></select>
                <label>–ö–∞–º–µ—Ä–∞</label><select id="sel-cam"></select>
                <label>–î–∏–Ω–∞–º–∏–∫–∏</label><select id="sel-spk"></select>
            </div>
            
            <button onclick="closeSettings()" style="background:var(--green); margin-top:20px;">–°–û–•–†–ê–ù–ò–¢–¨ –ò –í–´–ô–¢–ò</button>
        </div>
    </div>

    <div id="scr-reg" class="screen">
        <div class="card">
            <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
            <p style="color:#aaa">–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –æ–±—â–µ–Ω–∏—è</p>
            <input type="text" id="reg-nick" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫">
            <button onclick="document.getElementById('reg-file').click()" style="background:#4e5058">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
            <input type="file" id="reg-file" hidden accept="image/*" onchange="uploadAva(this, false)">
            <div id="reg-pre" style="width:100px; height:100px; border-radius:50%; margin:20px auto; background-size:cover; display:none; border:3px solid var(--accent)"></div>
            <button onclick="saveReg()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
        </div>
    </div>

    <div id="scr-lobby" class="screen" style="display:none">
        <div class="card">
            <div id="lob-ava" style="width:110px; height:110px; border-radius:50%; margin:0 auto 20px; background-size:cover; border:4px solid var(--accent); box-shadow: 0 0 20px rgba(88,101,242,0.4)"></div>
            <h2 id="lob-nick" style="margin-bottom:30px"></h2>
            <input type="text" id="room-id" placeholder="ID –ö–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: VIP-777)">
            <button onclick="start(true)" style="background:var(--green)">–°–û–ó–î–ê–¢–¨ –ö–û–ú–ù–ê–¢–£</button>
            <button onclick="start(false)">–í–û–ô–¢–ò –ö –î–†–£–ó–¨–Ø–ú</button>
            <button onclick="localStorage.clear(); location.reload()" style="background:transparent; color:#ff4747; font-size:12px; border:1px solid #ff4747; margin-top:20px">–£–î–ê–õ–ò–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
        </div>
    </div>

    <div id="main-app">
        <div class="video-side" id="video-grid"></div>
        <div class="chat-side">
            <div id="chat-msgs"></div>
            <div class="emoji-row">
                <span onclick="sendEmoji('üòä')">üòä</span><span onclick="sendEmoji('üòÇ')">üòÇ</span>
                <span onclick="sendEmoji('üî•')">üî•</span><span onclick="sendEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                <span onclick="sendEmoji('üëç')">üëç</span><span onclick="sendEmoji('ü§°')">ü§°</span>
            </div>
            <div style="padding:15px; display:flex; gap:10px; background:#2b2d31">
                <label style="cursor:pointer; background:#4e5058; width:45px; height:45px; display:flex; align-items:center; justify-content:center; border-radius:8px; font-size:20px">üìé<input type="file" hidden onchange="uploadFile(this)"></label>
                <input type="text" id="chat-in" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç..." style="margin:0" onkeypress="if(event.key==='Enter') sendChat()">
            </div>
        </div>
    </div>

    <div class="controls" id="ui-bar" style="display:none">
        <button id="mic-b" class="btn" onclick="mute('audio')" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">üé§</button>
        <button id="cam-b" class="btn" onclick="mute('video')" title="–ö–∞–º–µ—Ä–∞">üì∑</button>
        <button id="screen-b" class="btn" onclick="shareScreen()" title="–≠–∫—Ä–∞–Ω">üñ•Ô∏è</button>
        <button class="btn" onclick="openSettings()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
        <button class="btn" style="background:var(--red)" onclick="location.reload()" title="–í—ã–π—Ç–∏">üõë</button>
    </div>

    <script>
        let myStream, peer, myPeerId, conns = {};
        let profile = JSON.parse(localStorage.getItem('mega_v5_profile'));

        if(profile) initLobby();

        function uploadAva(input, isUpdate) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = e.target.result;
                if(isUpdate) { profile.ava = data; } 
                else { window.tempAva = data; document.getElementById('reg-pre').style.display='block'; document.getElementById('reg-pre').style.backgroundImage=`url(${data})`; }
            };
            reader.readAsDataURL(input.files[0]);
        }

        function saveReg() {
            const nick = document.getElementById('reg-nick').value;
            if(!nick) return alert("–ù–∏–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!");
            profile = { nick, ava: window.tempAva || '', id: 'user-'+Math.random().toString(36).substr(2,6) };
            localStorage.setItem('mega_v5_profile', JSON.stringify(profile));
            initLobby();
        }

        function initLobby() {
            document.getElementById('scr-reg').style.display='none';
            document.getElementById('scr-lobby').style.display='flex';
            document.getElementById('lob-nick').innerText = "–ì–æ—Ç–æ–≤ –∫ —Å–≤—è–∑–∏, " + profile.nick;
            document.getElementById('lob-ava').style.backgroundImage = `url(${profile.ava})`;
            listDevices();
        }

        async function listDevices() {
            const devs = await navigator.mediaDevices.enumerateDevices();
            const m = document.getElementById('sel-mic'), c = document.getElementById('sel-cam'), s = document.getElementById('sel-spk');
            m.innerHTML=c.innerHTML=s.innerHTML='';
            devs.forEach(d => {
                const o = `<option value="${d.deviceId}">${d.label || d.kind}</option>`;
                if(d.kind==='audioinput') m.innerHTML+=o;
                if(d.kind==='videoinput') c.innerHTML+=o;
                if(d.kind==='audiooutput') s.innerHTML+=o;
            });
        }

        async function start(isHost) {
            const rid = document.getElementById('room-id').value;
            if(!rid) return alert("–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã!");
            
            try {
                myStream = await navigator.mediaDevices.getUserMedia({audio:true, video:true});
            } catch { myStream = new MediaStream(); }

            document.getElementById('scr-lobby').style.display='none';
            document.getElementById('main-app').style.display='flex';
            document.getElementById('ui-bar').style.display='flex';

            myPeerId = isHost ? "mega-"+rid : "mega-"+rid+"-"+profile.id;
            peer = new Peer(myPeerId);

            peer.on('open', id => {
                addNode(profile.nick, profile.ava, myStream, true, id);
                if(!isHost) {
                    const host = "mega-"+rid;
                    const call = peer.call(host, myStream, {metadata: profile});
                    call.on('stream', s => addNode("–°–æ–∑–¥–∞—Ç–µ–ª—å", "", s, false, host));
                    handleData(peer.connect(host, {metadata: profile}));
                }
            });

            peer.on('call', call => {
                call.answer(myStream);
                call.on('stream', s => addNode(call.metadata.nick, call.metadata.ava, s, false, call.peer));
            });
            peer.on('connection', handleData);
        }

        function addNode(nick, ava, stream, isMe, id) {
            if(document.getElementById('n-'+id)) return;
            const grid = document.getElementById('video-grid');
            const div = document.createElement('div');
            div.className = 'user-node'; div.id = 'n-'+id;
            div.innerHTML = `
                <div class="v-wrap ${isMe?'me':''}" id="w-${id}">
                    <img src="${ava || ''}" class="ava-img" id="img-${id}">
                    <video id="v-${id}" autoplay ${isMe?'muted':''}></video>
                </div>
                <div style="font-weight:bold; color:${isMe?'var(--gold)':'white'}" id="txt-${id}">${nick} ${isMe?'(–í—ã)':''}</div>
                ${!isMe ? `<input type="range" style="width:80px" min="0" max="1" step="0.1" value="1" oninput="document.getElementById('v-${id}').volume=this.value">` : ''}
            `;
            grid.appendChild(div);
            document.getElementById('v-'+id).srcObject = stream;

            // –ì–æ–ª–æ—Å–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
            const actx = new AudioContext();
            const src = actx.createMediaStreamSource(stream);
            const ans = actx.createAnalyser();
            src.connect(ans);
            const dat = new Uint8Array(ans.frequencyBinCount);
            const loop = () => {
                ans.getByteFrequencyData(dat);
                const avg = dat.reduce((a,b)=>a+b)/dat.length;
                document.getElementById('w-'+id)?.classList.toggle('speaking', avg > 35);
                requestAnimationFrame(loop);
            };
            loop();
        }

        function openSettings() {
            document.getElementById('settings-modal').style.display='flex';
            document.getElementById('set-nick-input').value = profile.nick;
        }

        function closeSettings() {
            document.getElementById('settings-modal').style.display='none';
            saveSettings();
        }

        function saveSettings() {
            const newNick = document.getElementById('set-nick-input').value;
            if(newNick) profile.nick = newNick;
            localStorage.setItem('mega_v5_profile', JSON.stringify(profile));
            
            if(document.getElementById('txt-'+myPeerId)) {
                document.getElementById('txt-'+myPeerId).innerText = profile.nick + ' (–í—ã)';
                document.getElementById('img-'+myPeerId).src = profile.ava;
            }
            
            Object.values(conns).forEach(c => c.send({type:'update', n: profile.nick, a: profile.ava}));
            applyDevices();
        }

        async function applyDevices() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({
                    audio: {deviceId: document.getElementById('sel-mic').value},
                    video: {deviceId: document.getElementById('sel-cam').value}
                });
                const vT = s.getVideoTracks()[0];
                Object.values(peer.connections).forEach(ps => ps.forEach(c => {
                    if(c.type === 'media') {
                        const snd = c.peerConnection.getSenders().find(s=>s.track.kind==='video');
                        if(snd) snd.replaceTrack(vT);
                    }
                }));
                myStream = s;
                if(document.getElementById('v-'+myPeerId)) document.getElementById('v-'+myPeerId).srcObject = s;
                
                const spk = document.getElementById('sel-spk').value;
                document.querySelectorAll('video').forEach(v => { if(!v.muted && v.setSinkId) v.setSinkId(spk); });
            } catch(e) { console.log("Device error", e); }
        }

        function handleData(c) {
            conns[c.peer] = c;
            pushChat("–°–ò–°–¢–ï–ú–ê", `${c.metadata?.nick || '–£—á–∞—Å—Ç–Ω–∏–∫'} –≤–æ—à–µ–ª –≤ —Å–µ—Ç—å!`, null, true);
            c.on('data', d => {
                if(d.type==='msg') pushChat(d.n, d.m, d.f);
                if(d.type==='update') {
                    if(document.getElementById('txt-'+c.peer)) document.getElementById('txt-'+c.peer).innerText = d.n;
                    if(document.getElementById('img-'+c.peer)) document.getElementById('img-'+c.peer).src = d.a;
                }
            });
            c.on('close', () => {
                document.getElementById('n-'+c.peer)?.remove();
                pushChat("–°–ò–°–¢–ï–ú–ê", "–ö—Ç–æ-—Ç–æ –ø–æ–∫–∏–Ω—É–ª –Ω–∞—Å...");
            });
        }

        function mute(t) {
            const track = t==='audio' ? myStream.getAudioTracks()[0] : myStream.getVideoTracks()[0];
            if(!track) return;
            track.enabled = !track.enabled;
            document.getElementById(t==='audio'?'mic-b':'cam-b').classList.toggle('off', !track.enabled);
        }

        async function shareScreen() {
            try {
                const s = await navigator.mediaDevices.getDisplayMedia({video:true, audio:true});
                const t = s.getVideoTracks()[0];
                const btn = document.getElementById('screen-b');
                btn.classList.add('off');
                
                Object.values(conns).forEach(c => {
                    const snd = c.peerConnection.getSenders().find(s=>s.track.kind==='video');
                    if(snd) snd.replaceTrack(t);
                });
                document.getElementById('v-'+myPeerId).srcObject = s;
                
                t.onended = () => {
                    btn.classList.remove('off');
                    applyDevices();
                };
            } catch(e) {}
        }

        function sendChat() {
            const i = document.getElementById('chat-in');
            if(!i.value) return;
            Object.values(conns).forEach(c => c.send({type:'msg', n: profile.nick, m: i.value}));
            pushChat(profile.nick, i.value);
            i.value='';
        }

        function sendEmoji(e) {
            Object.values(conns).forEach(c => c.send({type:'msg', n: profile.nick, m: e}));
            pushChat(profile.nick, e);
        }

        function uploadFile(el) {
            const f = el.files[0];
            const r = new FileReader();
            r.onload = e => {
                const d = {type:'msg', n: profile.nick, m: `üìé [–§–∞–π–ª: ${f.name}]`, f: {d: e.target.result, t: f.type}};
                Object.values(conns).forEach(c => c.send(d));
                pushChat(profile.nick, d.m, d.f);
            };
            r.readAsDataURL(f);
        }

        function pushChat(n, m, f, isSys=false) {
            const b = document.getElementById('chat-msgs');
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            let h = `<div class="msg" style="${isSys?'border-left:4px solid var(--green); opacity:0.7':''}">
                <span style="font-size:10px; float:right; color:#888">${time}</span>
                <b>${n}</b> ${m}`;
            if(f) {
                if(f.t.startsWith('image')) h += `<br><img src="${f.d}" style="max-width:100%; border-radius:8px; margin-top:10px">`;
                else h += `<br><a href="${f.d}" download style="color:var(--accent); text-decoration:none">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a>`;
            }
            b.innerHTML += h + `</div>`;
            b.scrollTop = b.scrollHeight;
        }
    </script>
</body>
</html>
