<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TITAN ETERNAL - OMNI CONNECT</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #020205; --accent: #00f2ff; --green: #39ff14; --red: #ff3131; --text: #e0e0ff; }
        * { box-sizing: border-box; font-family: 'Orbitron', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .win { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 9000; background: var(--bg); }
        #app { display: none; flex: 1; flex-direction: row; height: calc(100vh - 80px); }
        .stage { flex: 1; display: flex; flex-wrap: wrap; padding: 20px; gap: 20px; overflow-y: auto; background: radial-gradient(circle at center, #0a0a20 0%, #020205 100%); }
        .u-box { width: 320px; aspect-ratio: 16/9; background: rgba(20,20,35,0.8); border-radius: 12px; position: relative; border: 2px solid var(--accent); overflow: hidden; box-shadow: 0 0 15px rgba(0,242,255,0.2); }
        video { width: 100%; height: 100%; object-fit: cover; display: none; background: #000; }
        video.active { display: block; }
        .u-ava { width: 80px; height: 80px; border-radius: 50%; background: #111 center/cover; border: 3px solid var(--accent); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; }
        .u-ava.hidden { opacity: 0; }
        .u-nick { position: absolute; bottom: 8px; left: 8px; font-size: 10px; background: rgba(0,0,0,0.8); padding: 3px 8px; border-radius: 4px; border: 1px solid var(--accent); }
        .side { width: 300px; background: rgba(10,10,15,0.95); border-left: 2px solid var(--accent); display: flex; flex-direction: column; }
        #msgs { flex: 1; overflow-y: auto; padding: 15px; font-size: 11px; }
        .m { background: rgba(255,255,255,0.05); padding: 8px; margin-bottom: 8px; border-radius: 4px; border-left: 2px solid var(--accent); }
        .dock { height: 80px; background: #000; border-top: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; gap: 20px; }
        .icn { width: 50px; height: 50px; border-radius: 50%; border: 1px solid var(--accent); background: none; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .icn.on { background: var(--green); color: #000; box-shadow: 0 0 15px var(--green); }
        .card { background: #0a0a15; padding: 30px; border-radius: 20px; border: 2px solid var(--accent); text-align: center; width: 320px; }
        input { width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid #333; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="w-auth" class="win">
        <div class="card">
            <h2 style="color:var(--accent)">TITAN OMNI</h2>
            <input type="text" id="i-nick" placeholder="–¢–í–û–ô –ü–û–ó–´–í–ù–û–ô">
            <button onclick="saveProfile()" style="width:100%; padding:15px; background:var(--accent); border:none; font-weight:bold; cursor:pointer">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>
    </div>

    <div id="w-lobby" class="win" style="display:none">
        <div class="card">
            <h3 id="l-nick"></h3>
            <input type="text" id="i-room" placeholder="ID –ö–û–ú–ù–ê–¢–´ (–õ–Æ–ë–û–ô)">
            <button onclick="connect()" style="width:100%; padding:15px; background:var(--green); border:none; font-weight:bold; cursor:pointer">–í–û–ô–¢–ò –í –°–ï–¢–¨</button>
        </div>
    </div>

    <div id="app">
        <div class="stage" id="stage"></div>
        <div class="side">
            <div style="padding:10px; font-size:10px; color:var(--accent)">–°–ï–¢–ï–í–û–ô –°–ü–ò–°–û–ö:</div>
            <div id="u-items" style="padding:0 10px; color:var(--green); font-size:12px"></div>
            <div id="msgs"></div>
            <div style="padding:10px; display:flex; gap:5px">
                <input type="text" id="c-in" placeholder="–°–≤—è–∑—å..." onkeypress="if(event.key==='Enter') sendMsg()">
                <button onclick="sendMsg()" style="background:var(--accent); border:none; padding:10px;">></button>
            </div>
        </div>
    </div>

    <div class="dock" id="main-dock" style="display:none">
        <button id="b-mic" class="icn" onclick="media('audio')">üéôÔ∏è</button>
        <button id="b-cam" class="icn" onclick="media('video')">üì∑</button>
        <button class="icn" style="background:var(--red)" onclick="location.reload()">üö™</button>
    </div>

    <script>
        let myStream = new MediaStream(), peer, myId, conns = {}, roomID;
        let profile = JSON.parse(localStorage.getItem('titan_p')) || {nick:'', id: Math.random().toString(36).substr(2,6)};

        if(profile.nick) showLobby();

        function saveProfile() {
            const n = document.getElementById('i-nick').value;
            if(!n) return; profile.nick = n;
            localStorage.setItem('titan_p', JSON.stringify(profile));
            location.reload();
        }

        function showLobby() {
            document.getElementById('w-auth').style.display='none';
            document.getElementById('w-lobby').style.display='flex';
            document.getElementById('l-nick').innerText = "–ü–†–ò–í–ï–¢, " + profile.nick;
        }

        function connect() {
            roomID = document.getElementById('i-room').value.trim();
            if(!roomID) return;
            document.querySelectorAll('.win').forEach(w=>w.style.display='none');
            document.getElementById('app').style.display='flex';
            document.getElementById('main-dock').style.display='flex';

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –ø—Ä–æ–±–∏—Ç–∏—è NAT
            peer = new Peer("titan-" + roomID + "-" + profile.id, {
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun.services.mozilla.com' }
                    ]
                }
            });

            peer.on('open', (id) => {
                myId = id;
                addBox(profile.nick, myId, true);
                updateList(myId, profile.nick);
                
                // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∏—â–µ–º –¥—Ä—É–≥–∏—Ö (–≥—Ä—É–±–∞—è, –Ω–æ —Ä–∞–±–æ—á–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–Ω–ª–∞–π–Ω-–ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è)
                setInterval(() => {
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Ç—É—Ç –Ω—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä-—Å–ø–∏—Å–æ—á–Ω–∏–∫, 
                    // –Ω–æ –º—ã –ø–æ–ø—Ä–æ–±—É–µ–º —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è —Å "–±–∞–∑–æ–≤—ã–º" ID –∫–æ–º–Ω–∞—Ç—ã
                    const c = peer.connect("titan-" + roomID + "-host", {metadata: profile});
                    if(c) bind(c);
                }, 5000);

                // –ü—ã—Ç–∞–µ–º—Å—è —Å–∞–º–∏ —Å—Ç–∞—Ç—å —Ö–æ—Å—Ç–æ–º, –µ—Å–ª–∏ –º–µ—Å—Ç–æ —Å–≤–æ–±–æ–¥–Ω–æ
                const hostPeer = new Peer("titan-" + roomID + "-host");
                hostPeer.on('connection', bind);
                hostPeer.on('call', call => {
                    call.answer(myStream);
                    handleStream(call);
                });
            });

            peer.on('connection', bind);
            peer.on('call', call => {
                call.answer(myStream);
                handleStream(call);
            });
        }

        function bind(c) {
            if(conns[c.peer]) return;
            conns[c.peer] = c;
            c.on('open', () => {
                c.send({type:'init', n:profile.nick});
                peer.call(c.peer, myStream, {metadata: profile});
            });
            c.on('data', d => {
                if(d.type==='init') { addBox(d.n, c.peer); updateList(c.peer, d.n); }
                if(d.type==='msg') pushChat(d.n, d.m);
            });
            c.on('close', () => { document.getElementById('u-'+c.peer)?.remove(); });
        }

        function handleStream(call) {
            addBox(call.metadata?.nick || "–î—Ä—É–≥", call.peer);
            call.on('stream', s => {
                const v = document.getElementById('vid-u-'+call.peer);
                if(v) { v.srcObject = s; v.onloadedmetadata = () => v.classList.add('active'); }
            });
        }

        function addBox(n, id, isMe) {
            if(document.getElementById('u-'+id)) return;
            const b = document.createElement('div');
            b.className = 'u-box'; b.id = 'u-'+id;
            b.innerHTML = `
                <div class="u-ava" id="ava-${id}"></div>
                <div class="u-nick">${n}</div>
                <video id="vid-u-${id}" autoplay playsinline ${isMe?'muted':''}></video>
            `;
            document.getElementById('stage').appendChild(b);
        }

        function updateList(id, n) {
            const l = document.getElementById('u-items');
            if(!l.innerHTML.includes(n)) l.innerHTML += `<div>‚óè ${n}</div>`;
        }

        async function media(t) {
            const s = await navigator.mediaDevices.getUserMedia(t==='video'?{video:true}:{audio:true});
            const trk = s.getTracks()[0];
            myStream.addTrack(trk);
            const btn = document.getElementById(t==='video'?'b-cam':'b-mic');
            btn.classList.add('on');
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ç–æ–∫ —É –≤—Å–µ—Ö
            Object.values(conns).forEach(c => peer.call(c.peer, myStream, {metadata: profile}));
            const myV = document.getElementById('vid-u-'+myId);
            if(t==='video') { myV.srcObject = myStream; myV.classList.add('active'); document.getElementById('ava-'+myId).classList.add('hidden'); }
        }

        function sendMsg() {
            const i = document.getElementById('c-in');
            Object.values(conns).forEach(c => c.send({type:'msg', n:profile.nick, m:i.value}));
            pushChat("–Ø", i.value); i.value = '';
        }

        function pushChat(n, m) {
            const b = document.getElementById('msgs');
            b.innerHTML += `<div class="m"><b>${n}:</b> ${m}</div>`;
            b.scrollTop = b.scrollHeight;
        }
    </script>
</body>
</html>
